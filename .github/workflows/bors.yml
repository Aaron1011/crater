name: bors build
on:
  push:
    branches:
      - try
      - auto

jobs:
  lint:
    name: Linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master

      - name: Install Rust stable
        run: rustup update stable && rustup default stable

      - name: Check the code formatting with rustfmt
        run: cargo fmt --all -- --check

      - name: Ensure there are no warnings with Clippy
        run: cargo clippy --all -- -Dwarnings

      - name: Check if the configuration is correct
        run: |
          cargo run -- create-lists
          cargo run -- check-config

  test:
    name: Testing
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest]
        channel: [stable, beta, nightly]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@master

      - name: Install Rust ${{ matrix.channel }}
        shell: bash
        run: rustup update $CHANNEL && rustup default $CHANNEL
        env:
          CHANNEL: ${{ matrix.channel }}

      - name: Build Crater
        shell: bash
        run: cargo build

      - name: Run Crater tests
        shell: bash
        run: |
          cargo run -- create-lists
          cargo test

  minicrater:
    name: Minicrater
    strategy:
      matrix:
        os: [ubuntu-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@master

      - name: Install Rust stable
        run: rustup update stable && rustup default stable

      - name: Run minicrater
        shell: bash
        run: |
          cargo run -- create-lists
          cargo test -- --ignored --nocapture --test-threads 1
        env:
          MINICRATER_FAST_WORKSPACE_INIT: 1
          MINICRATER_SHOW_OUTPUT: 1

  # These jobs doesn't actually test anything, but they're only used to tell
  # bors the build completed, as there is no practical way to detect when a
  # workflow is successful listening to webhooks only.
  #
  # ALL THE PREVIOUS JOBS NEEDS TO BE ADDED TO THE `needs` SECTION OF THIS JOB!

  end-success:
    name: bors build finished
    if: success()
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
      - minicrater

    steps:
      - name: Mark the job as successful
        run: exit 0

  end-failure:
    name: bors build finished
    if: "!success()"
    runs-on: ubuntu-latest
    needs:
      - lint
      - test
      - minicrater

    steps:
      - name: Mark the job as a failure
        run: exit 1
