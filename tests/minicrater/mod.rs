use assert_cmd::prelude::*;
use common::CommandCraterExt;
use difference::Changeset;
use rand::{self, distributions::Alphanumeric, Rng};
use serde_json::{self, Value};
use std::path::PathBuf;
use std::process::Command;

#[test]
fn run() {
    let minicrater_dir = PathBuf::from("tests").join("minicrater");

    let report_dir = ::tempfile::tempdir().expect("failed to create report dir");
    let ex_arg = format!(
        "--ex=minicrater-{}",
        rand::thread_rng()
            .sample_iter(&Alphanumeric)
            .take(10)
            .collect::<String>()
    );

    // Create local list in the temp work dir
    Command::crater()
        .args(&["create-lists", "local"])
        .assert()
        .success();

    // Define the experiment
    Command::crater()
        .args(&[
            "define-ex",
            &ex_arg,
            "stable",
            "beta",
            "--crate-select=local",
        ]).assert()
        .success();

    // Execute the experiment
    Command::crater()
        .args(&["run-graph", &ex_arg])
        .assert()
        .success();

    // Generate the report
    Command::crater()
        .args(&["gen-report", &ex_arg])
        .arg(report_dir.path())
        .assert()
        .success();

    // Read the JSON report
    let json_report = ::std::fs::read(report_dir.path().join("results.json"))
        .expect("failed to read json report");

    // Delete the experiment
    Command::crater()
        .args(&["delete-ex", &ex_arg])
        .assert()
        .success();

    // Load the generated JSON report
    let parsed_report: Value = serde_json::from_slice(&json_report).expect("invalid json report");
    let mut actual_report = serde_json::to_vec_pretty(&parsed_report).unwrap();
    actual_report.push(b'\n');

    // Load the expected JSON report
    let expected_report =
        ::std::fs::read(minicrater_dir.join("results.expected.json")).unwrap_or(Vec::new());

    // Write the actual JSON report
    ::std::fs::write(minicrater_dir.join("results.actual.json"), &actual_report)
        .expect("failed to write copy of the json report");

    let changeset = Changeset::new(
        &String::from_utf8(expected_report).expect("invalid utf-8 in the expected report"),
        &String::from_utf8(actual_report.clone()).expect("invalid utf-8 in the actual report"),
        "\n",
    );
    if changeset.distance != 0 {
        eprintln!(
            "Difference between expected and actual reports:\n{}",
            changeset
        );
        eprintln!("To expect the new report in the future run:");
        eprintln!(
            "$ cp tests/minicrater/results.actual.json tests/minicrater/results.expected.json\n"
        );
        panic!("invalid report generated by Crater");
    }
}
